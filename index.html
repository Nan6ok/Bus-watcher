<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>香港 3D 巴士示範</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #mapStyleBtn {
      position:absolute; top:10px; left:10px; z-index:10;
      padding:8px 12px; background:white; border:none; border-radius:5px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="mapStyleBtn">切換地圖風格</button>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
    // Mapbox 初始化
    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [114.157, 22.285],
      zoom: 14,
      pitch: 60,
      bearing: -17,
      antialias: true
    });

    // Three.js 變數
    let threeScene, threeCamera, threeRenderer;
    const Bus3DMarkers = {};

    function initThreeLayer() {
      threeScene = new THREE.Scene();
      threeCamera = new THREE.PerspectiveCamera();

      map.addLayer({
        id: '3d-bus-layer',
        type: 'custom',
        renderingMode: '3d',
        onAdd: function(map, gl) {
          threeRenderer = new THREE.WebGLRenderer({
            canvas: map.getCanvas(),
            context: gl,
            antialias: true
          });
          threeRenderer.autoClear = false;
        },
        render: function(gl, matrix) {
          const m = new THREE.Matrix4().fromArray(matrix);
          threeCamera.projectionMatrix = m;
          threeRenderer.state.reset();
          threeRenderer.render(threeScene, threeCamera);
          map.triggerRepaint();
        }
      });
    }

    // 生成 3D 巴士長方形
    function addBus3D(busKey, brand, lng, lat) {
      if (Bus3DMarkers[busKey]) return;

      let color = 0xff0000; // KMB 紅色
      if (brand === 'ctb') color = 0xffff00; // CTB 黃色
      if (brand === 'nlb') color = 0x3399ff; // NLB 藍綠色

      const geometry = new THREE.BoxGeometry(0.0005, 0.0002, 0.0002);
      const material = new THREE.MeshStandardMaterial({ color });
      const bus = new THREE.Mesh(geometry, material);

      const coords = mapboxgl.MercatorCoordinate.fromLngLat({ lng, lat }, 0);
      bus.position.set(coords.x, coords.y, coords.z);

      Bus3DMarkers[busKey] = bus;
      threeScene.add(bus);
    }

    map.on('load', () => {
      initThreeLayer();

      // 放三台巴士長方形
      addBus3D('KMB-1', 'kmb', 114.157, 22.285);
      addBus3D('CTB-2', 'ctb', 114.158, 22.286);
      addBus3D('NLB-3', 'nlb', 114.159, 22.284);
    });

    // 切換地圖風格
    document.getElementById('mapStyleBtn').addEventListener('click', () => {
      const current = map.getStyle().name;
      if (current === 'Mapbox Light') map.setStyle('mapbox://styles/mapbox/dark-v11');
      else map.setStyle('mapbox://styles/mapbox/light-v11');
    });
  </script>
</body>
</html>
