<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>香港 3D 巴士 Mini Tokyo</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #mapStyleBtn {
      position:absolute; top:10px; left:10px; z-index:10;
      padding:8px 12px; background:white; border:none; border-radius:5px; cursor:pointer;
    }
    #routeInfo {
      position:absolute; top:50px; left:10px; z-index:10;
      background:white; padding:8px 12px; border-radius:5px;
      max-width:250px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="mapStyleBtn">切換地圖風格</button>
  <div id="routeInfo">點擊巴士顯示路線資訊</div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [114.157, 22.285],
      zoom: 14,
      pitch: 60,
      bearing: -17,
      antialias: true
    });

    // ---------------- Three.js ----------------
    let threeScene, threeCamera, threeRenderer;
    const Bus3DMarkers = {}; // busKey -> THREE.Mesh
    const BusRoutes = {}; // busKey -> route array

    function initThreeLayer() {
      threeScene = new THREE.Scene();
      threeCamera = new THREE.PerspectiveCamera();

      map.addLayer({
        id: '3d-bus-layer',
        type: 'custom',
        renderingMode: '3d',
        onAdd: function(map, gl) {
          threeRenderer = new THREE.WebGLRenderer({
            canvas: map.getCanvas(),
            context: gl,
            antialias: true
          });
          threeRenderer.autoClear = false;
        },
        render: function(gl, matrix) {
          const m = new THREE.Matrix4().fromArray(matrix);
          threeCamera.projectionMatrix = m;
          threeRenderer.state.reset();
          threeRenderer.render(threeScene, threeCamera);
          map.triggerRepaint();
        }
      });
    }

    // ---------------- 生成巴士 ----------------
    function addBus3D(busKey, brand, route) {
      let color = 0xff0000; // KMB
      if (brand === 'ctb') color = 0xffff00;
      if (brand === 'nlb') color = 0x3399ff;

      const geometry = new THREE.BoxGeometry(0.0005, 0.0002, 0.0002);
      const material = new THREE.MeshStandardMaterial({ color });
      const bus = new THREE.Mesh(geometry, material);

      const start = route[0];
      const coords = mapboxgl.MercatorCoordinate.fromLngLat({ lng: start.lng, lat: start.lat }, 0);
      bus.position.set(coords.x, coords.y, coords.z);

      bus.userData = { route: route, brand: brand }; // 存路線資料
      Bus3DMarkers[busKey] = bus;
      BusRoutes[busKey] = route;
      threeScene.add(bus);
    }

    // ---------------- 更新巴士位置 ----------------
    function updateBuses() {
      const now = Date.now() / 1000; // 秒
      Object.keys(Bus3DMarkers).forEach(busKey => {
        const bus = Bus3DMarkers[busKey];
        const route = bus.userData.route;
        const t = (now % route.length);
        const i0 = Math.floor(t);
        const i1 = (i0 + 1) % route.length;
        const ratio = t - i0;
        const p0 = route[i0];
        const p1 = route[i1];

        const lng = p0.lng + (p1.lng - p0.lng) * ratio;
        const lat = p0.lat + (p1.lat - p0.lat) * ratio;
        const coords = mapboxgl.MercatorCoordinate.fromLngLat({ lng, lat }, 0);
        bus.position.set(coords.x, coords.y, coords.z);

        // 朝向
        bus.rotation.y = Math.atan2(p1.lng - p0.lng, p1.lat - p0.lat);
      });
    }
    setInterval(updateBuses, 1000);

    // ---------------- 點擊巴士顯示路線 ----------------
    map.on('click', (e) => {
      const mouse = new THREE.Vector2();
      mouse.x = (e.point.x / map.getCanvas().width) * 2 - 1;
      mouse.y = -(e.point.y / map.getCanvas().height) * 2 + 1;

      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, threeCamera);
      const intersects = raycaster.intersectObjects(Object.values(Bus3DMarkers));

      if (intersects.length > 0) {
        const bus = intersects[0].object;
        const routeInfo = document.getElementById('routeInfo');
        routeInfo.innerHTML = `品牌: ${bus.userData.brand.toUpperCase()}<br>路線: ${bus.userData.route.map(p=>`[${p.lng.toFixed(3)},${p.lat.toFixed(3)}]`).join(' → ')}`;
      }
    });

    // ---------------- 初始化地圖和巴士 ----------------
    map.on('load', () => {
      initThreeLayer();

      // 範例路線
      const routeKMB = [{lng:114.157,lat:22.285},{lng:114.158,lat:22.286},{lng:114.159,lat:22.287}];
      const routeCTB = [{lng:114.158,lat:22.284},{lng:114.159,lat:22.285},{lng:114.16,lat:22.286}];
      const routeNLB = [{lng:114.156,lat:22.284},{lng:114.157,lat:22.283},{lng:114.158,lat:22.284}];

      addBus3D('KMB-1','kmb', routeKMB);
      addBus3D('CTB-2','ctb', routeCTB);
      addBus3D('NLB-3','nlb', routeNLB);
    });

    // ---------------- 切換地圖風格 ----------------
    document.getElementById('mapStyleBtn').addEventListener('click', () => {
      const current = map.getStyle().name;
      if (current === 'Mapbox Light') map.setStyle('mapbox://styles/mapbox/dark-v11');
      else map.setStyle('mapbox://styles/mapbox/light-v11');
    });
  </script>
</body>
</html>
